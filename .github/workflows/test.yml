name: Test

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run golangci-lint
        continue-on-error: true
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m --skip-dirs=tests
          skip-pkg-cache: true
          skip-build-cache: true

  build-chaincodes:
    name: Build Chaincodes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chaincode: [as-chaincode, tgs-chaincode, isv-chaincode]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Download dependencies
        run: |
          cd chaincodes/${{ matrix.chaincode }}
          go mod tidy
          go mod download

      - name: Build chaincode
        run: |
          cd chaincodes/${{ matrix.chaincode }}
          go build -v ./...

  # integration-tests:
  #   name: Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: [build-chaincodes]
  #   if: false  # Disabled for now - enable when network setup is complete
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - name: Run integration tests
  #       run: echo "Integration tests disabled"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run basic Go vet
        continue-on-error: true
        run: |
          for dir in chaincodes/as-chaincode chaincodes/tgs-chaincode chaincodes/isv-chaincode chaincodes/common; do
            echo "Checking $dir..."
            cd $dir && go vet ./... && cd -
          done
